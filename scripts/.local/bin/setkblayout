#!/bin/sh

usage() {
	echo "Usage: $0 [-v <string>] [-l <string>]" 1>&2; exit 1;
}

setup() {
	setxkbmap -option caps:escape
	xset r rate 300 50
}

while getopts ":l:v:" arg; do
	case "$arg" in
		l)
			layout="$OPTARG"
			[ -z "$layout" ] && usage
			;;
		v)
			variant="$OPTARG"
			[ -z "$variant" ] && usage
			;;
		*)
			layout=""
			variant=""
	esac
done

if [ -z "$layout" ]; then
	kb_choice="$(awk '/! layout/{flag=1; next} /! variant/{flag=0} flag {print $2, "- " $1}' /usr/share/X11/xkb/rules/base.lst | rofi -dmenu -i -p "Choose a keyboard layout")"
	kb="$(echo "$kb_choice" | awk '{print $3}')"
	[ -z "$kb" ] && exit
	setxkbmap "$kb" "$variant"
else
	setxkbmap "$layout" "$variant"
fi
setup

[ -z "$layout" ] && notify-send "‚å® Keyboard layout" "$(printf "%s" "Current layout: $(setxkbmap -query | grep -oP 'layout:\s*\K\w+')")"
